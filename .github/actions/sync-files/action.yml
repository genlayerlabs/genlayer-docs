name: 'Sync Files'
description: 'Generic file/directory synchronization with filtering and exclusions'
inputs:
  type:
    description: 'Type identifier for the sync operation (for artifact naming)'
    required: true
  title:
    description: 'Human-readable title for reports'
    required: true
  source_path:
    description: 'Source file or directory path'
    required: true
  target_path:
    description: 'Target file or directory path'
    required: true
  filter_pattern:
    description: 'Regex pattern to filter files (only for directories)'
    required: false
    default: '.*'
  exclude_files:
    description: 'Comma-separated list of filenames to exclude'
    required: false
    default: 'README,CHANGELOG,.gitignore,.gitkeep'
outputs:
  added:
    description: 'Number of files added'
    value: ${{ steps.sync.outputs.added }}
  updated:
    description: 'Number of files updated'
    value: ${{ steps.sync.outputs.updated }}
  deleted:
    description: 'Number of files deleted'
    value: ${{ steps.sync.outputs.deleted }}
  total:
    description: 'Total number of changes'
    value: ${{ steps.sync.outputs.total }}
runs:
  using: 'composite'
  steps:
    - name: Prepare config file
      if: inputs.type == 'config'
      shell: bash
      run: |
        # For config type, handle special case:
        # Copy config.yaml.example to temp location as config.yaml

        if [[ -f "${{ inputs.source_path }}" ]]; then
          # Create temp directory
          TEMP_DIR=$(mktemp -d)
          echo "TEMP_CONFIG_DIR=$TEMP_DIR" >> $GITHUB_ENV

          # Copy and rename config.yaml.example to config.yaml
          cp "${{ inputs.source_path }}" "$TEMP_DIR/config.yaml"

          # Update source path for sync
          echo "CONFIG_SOURCE=$TEMP_DIR/config.yaml" >> $GITHUB_ENV
        else
          echo "Config source file not found: ${{ inputs.source_path }}"
          exit 1
        fi

    - name: Prepare docker-compose file
      if: inputs.type == 'docker_compose'
      shell: bash
      run: |
        # For docker_compose type, handle special case:
        # Copy and sanitize (remove alloy service and volumes)

        if [[ -f "${{ inputs.source_path }}" ]]; then
          # Create temp directory
          TEMP_DIR=$(mktemp -d)
          echo "TEMP_DOCKER_COMPOSE_DIR=$TEMP_DIR" >> $GITHUB_ENV

          # Copy docker-compose.yaml
          cp "${{ inputs.source_path }}" "$TEMP_DIR/docker-compose.yaml"

          # Sanitize: remove alloy service and volumes section using yq
          bash .github/scripts/sanitize-docker-compose.sh "$TEMP_DIR/docker-compose.yaml"

          # Update source path for sync
          echo "DOCKER_COMPOSE_SOURCE=$TEMP_DIR/docker-compose.yaml" >> $GITHUB_ENV
        else
          echo "Docker compose source file not found: ${{ inputs.source_path }}"
          exit 1
        fi

    - name: Sync files
      id: sync
      shell: bash
      run: |
        # Use prepared source for config/docker_compose types, otherwise use original source
        if [[ "${{ inputs.type }}" == "config" ]] && [[ -n "$CONFIG_SOURCE" ]]; then
          SOURCE_PATH="$CONFIG_SOURCE"
        elif [[ "${{ inputs.type }}" == "docker_compose" ]] && [[ -n "$DOCKER_COMPOSE_SOURCE" ]]; then
          SOURCE_PATH="$DOCKER_COMPOSE_SOURCE"
        else
          SOURCE_PATH="${{ inputs.source_path }}"
        fi

        ${{ github.action_path }}/sync.sh \
          "${{ inputs.type }}" \
          "${{ inputs.title }}" \
          "$SOURCE_PATH" \
          "${{ inputs.target_path }}" \
          "${{ inputs.filter_pattern }}" \
          "${{ inputs.exclude_files }}"
    
    - name: Cleanup config temp directory
      if: inputs.type == 'config' && always()
      shell: bash
      run: |
        if [[ -n "$TEMP_CONFIG_DIR" ]] && [[ -d "$TEMP_CONFIG_DIR" ]]; then
          rm -rf "$TEMP_CONFIG_DIR"
        fi

    - name: Cleanup docker-compose temp directory
      if: inputs.type == 'docker_compose' && always()
      shell: bash
      run: |
        if [[ -n "$TEMP_DOCKER_COMPOSE_DIR" ]] && [[ -d "$TEMP_DOCKER_COMPOSE_DIR" ]]; then
          rm -rf "$TEMP_DOCKER_COMPOSE_DIR"
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: synced-${{ inputs.type }}
        path: artifacts/
        retention-days: 1